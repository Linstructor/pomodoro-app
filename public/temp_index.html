<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="assets/css/fa-regular.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="settings-button" class="far fa-cog"></div>

<div id="main" style="display: flex; flex-direction: column; justify-content: center; width: 100%; height: 100%">
  <p id="time"><input id="input" value="00" type="number" max="99">:<span id="secondes">00</span></p>
</div>

<div id="indicator-container">
  <div>
    <div class="rect"></div>
    <div class="circle"></div>
    <div class="rect"></div>
    <div class="circle"></div>
    <div class="rect"></div>
    <div class="circle"></div>
    <div class="rect"></div>
  </div>
</div>

<script>
  function initStorage() {
    const set = (key, value) => window.localStorage.setItem(key, value);
    set('duration', 25);
    set('alwaysOnTop', true);
    set('first', true);
  }


  function initActions() {
    document.getElementById('actions').addEventListener('click', event => {
      let el;
      if (event.srcElement.localName === 'div') el = event.srcElement;
      if (event.srcElement.localName === 'p') el = event.srcElement.parentElement;

      switch (el.id) {
        case 'restart': {
          document.getElementById('actions').style.display = ' none';
          state.set('end');
          require('electron').ipcRenderer.send('end');
          resetCounter();
          break;
        }
        case 'playback': {
          console.log(el.getAttribute('data-action'));
          require('electron').ipcRenderer.send('action', el.getAttribute('data-action'));
          if (el.getAttribute('data-action') === 'pause') {
            state.set('pause');
            el.setAttribute('data-action', 'play');
            document.getElementById('play').style.display = 'block';
            document.getElementById('pause').style.display = 'none';
          } else {
            if (state.get() === 'pause') {
              state.set('counting');
              runTime(document.body.getAttribute('data-duration'), JSON.parse(document.body.getAttribute('data-save')));
              document.body.removeAttribute('data-save');
            }
            el.setAttribute('data-action', 'pause');
            document.getElementById('pause').style.display = 'block';
            document.getElementById('play').style.display = 'none';
          }

          break;
        }
      }
    })
  }

  function initView() {
    document.getElementById('input').value = window.localStorage.getItem('duration');

    initSettingsPage();
    initActions();

    document.getElementById('settings-button').addEventListener('click', () => {
      showSettings();
    });

    document.getElementById('input').addEventListener('keypress', event => {
      if (document.getElementById('input').value.toString().length === 2) event.preventDefault();
    });

    document.getElementById('input').addEventListener('mouseleave', event => {
      event.srcElement.blur();
    });

    document.body.addEventListener('click', event => {
      if (event.srcElement.id !== 'main' || state.get() === 'counting') return;
      prepareCounter();
      runTime(document.getElementById('input').value);
    });

    document.addEventListener('mouseover', event => {
      if (state.get() === 'waiting') return;
      document.getElementById('actions').style.display = 'block';
    });

    document.addEventListener('mouseleave', event => {
      if (state.get() === 'waiting') return;
      document.getElementById('actions').style.display = ' none';
    })
  }

  function to2Digit(number) {
    if (number < 10 && number.toString().length != 2) return '0'+number;
    return number;
  }

  function setNumber(minutes, secondes) {
    document.getElementById('input').value = to2Digit(minutes);
    document.getElementById('secondes').innerText = to2Digit(secondes);
  }

  function prepareCounter() {
    state.set('counting');
    document.getElementById('input').readOnly = true;
    document.getElementById('input').style.cursor = 'default';
    require('electron').ipcRenderer.send('start');
    document.body.style.backgroundColor = 'transparent';
    document.getElementById('indicator-container').style.display = 'none';
    document.getElementById('settings-button').style.display = 'none';
    document.body.setAttribute('data-duration', document.getElementById('input').value);
  }

  function resetCounter() {
    setNumber(document.body.getAttribute('data-duration'), '00');
    state.set('waiting');
    document.body.style.backgroundColor = 'white';
    document.getElementById('indicator-container').style.display = 'flex';
    document.getElementById('input').readOnly = false;
    document.getElementById('input').style.cursor = 'text';
    document.getElementById('settings-button').style.display = 'block';
    state.set('waiting');
  }

  function runTime(minutes, currentState = undefined) {
    let nextState = undefined;
    if (document.body.getAttribute('data-state') === 'pause') return document.body.setAttribute('data-save', JSON.stringify(currentState));
    if (document.body.getAttribute('data-state') !== 'counting') return;
    if (currentState !== undefined) {
      setNumber(currentState.minutes, currentState.secondes);
      if (currentState.secondes === 0 && currentState.minutes === 0) {
        require('electron').ipcRenderer.send('end');
        resetCounter();
        currentStep.add();
        return;
      }
      nextState = Object.create(currentState);
      nextState.minutes = currentState.minutes;
      if (currentState.secondes === 0) {
        nextState.minutes = currentState.minutes - 1;
        nextState.secondes = 59;
      } else {
        nextState.secondes = currentState.secondes -1;
      }
    } else {
      nextState = {
        minutes: minutes,
        secondes: 0
      };
    }
    setTimeout(() => runTime(minutes, nextState), 1000);
    // console.log('count');
  }

  const currentStep = {
    set: (number) => {
      if (number > 3) return;
      document.body.setAttribute('data-step', number);
      for (let i = 0; i < number; i++) {
        document.getElementsByClassName('circle')[i].classList.add('active');
      }
    },
    get: () => document.body.getAttribute('data-step'),
    reset: () => this.set(0),
    add: () => this.set(this.get()+1),
  };

  const state = {
    set: newState => document.body.setAttribute('data-state', newState),
    get: () => document.body.getAttribute('data-state')
  };

  function showSettings() {
    document.getElementById('settings').style.display = 'block';
  }

  if (window.localStorage.length === 0) initStorage();

  initView();
  state.set('waiting');

</script>

</body>
</html>